<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 1 - English Language Arts</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/responsive.css">
</head>
<body>
    <div id="header-container"></div>
    <main class="chapter-container" id="main-content">
        <div class="chapter-header">
            <div class="chapter-number">Chapter 1</div>
            <h1 class="chapter-title">Reading & Writing Fundamentals</h1>
        </div>
        <div class="lesson-content">
            <div class="lesson-section">
                <h2><span class="section-icon">üìö</span>Reading Comprehension & Analysis</h2>
                <div class="reading-passage-container">
                    <div class="passage-selector">
                        <label for="passage-select">Choose a Reading Passage:</label>
                        <select id="passage-select" onchange="loadReadingPassage()">
                            <option value="adventure">The Great Adventure</option>
                            <option value="friendship">True Friendship</option>
                            <option value="mystery">The Missing Key</option>
                            <option value="nature">Exploring Nature</option>
                        </select>
                    </div>
                    
                    <div class="reading-passage" id="reading-passage">
                        <div class="passage-header">
                            <h3 id="passage-title">The Great Adventure</h3>
                            <div class="reading-controls">
                                <div class="reading-timer">
                                    <span class="timer-icon">‚è±Ô∏è</span>
                                    <span id="reading-timer">0:00</span>
                                </div>
                                <button type="button" id="narration-btn" class="narration-button" onclick="toggleNarration()" title="Listen to passage" aria-pressed="false">
                                    üîä Listen
                                </button>
                                <button type="button" id="highlight-btn" class="highlight-button" onclick="toggleHighlighting()" title="Highlight as you read" aria-pressed="false">
                                    ‚ú® Highlight
                                </button>
                            </div>
                        </div>
                        <div class="passage-text" id="passage-text">
                            <p>Sarah had always dreamed of exploring the mysterious forest behind her grandmother's house. The towering trees seemed to whisper secrets, and the winding paths promised exciting discoveries. One sunny morning, she finally gathered the courage to venture into the unknown wilderness.</p>
                            
                            <p>As she walked deeper into the forest, Sarah noticed how the sunlight filtered through the leaves, creating dancing shadows on the forest floor. She heard the cheerful chirping of birds and the gentle rustling of leaves in the breeze. The air smelled fresh and earthy, filled with the scent of pine needles and wildflowers.</p>
                            
                            <p>Suddenly, Sarah spotted something unusual. A small, wooden door was carved into the trunk of an enormous oak tree. Her heart raced with excitement as she approached the mysterious entrance. What adventures awaited her on the other side?</p>
                        </div>
                    </div>
                    
                    <div class="comprehension-questions" id="comprehension-questions" role="region" aria-labelledby="reading-questions-title">
                        <h4 id="reading-questions-title">üìù Reading Comprehension Questions</h4>
                        <div class="question-container">
                            <div class="question" data-question="1">
                                <p><strong>1. What had Sarah always dreamed of doing?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q1" value="a"> Climbing mountains</label>
                                    <label><input type="radio" name="q1" value="b"> Exploring the forest</label>
                                    <label><input type="radio" name="q1" value="c"> Swimming in the lake</label>
                                    <label><input type="radio" name="q1" value="d"> Building a treehouse</label>
                                </div>
                            </div>
                            
                            <div class="question" data-question="2">
                                <p><strong>2. How did Sarah feel when she found the wooden door?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q2" value="a"> Scared and worried</label>
                                    <label><input type="radio" name="q2" value="b"> Bored and tired</label>
                                    <label><input type="radio" name="q2" value="c"> Excited and curious</label>
                                    <label><input type="radio" name="q2" value="d"> Angry and frustrated</label>
                                </div>
                            </div>
                            
                            <div class="question" data-question="3">
                                <p><strong>3. What sensory details does the author use to describe the forest?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q3" value="a"> Only what Sarah could see</label>
                                    <label><input type="radio" name="q3" value="b"> Only what Sarah could hear</label>
                                    <label><input type="radio" name="q3" value="c"> Sight, sound, and smell</label>
                                    <label><input type="radio" name="q3" value="d"> Only what Sarah could touch</label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="check-answers-btn" onclick="checkReadingAnswers()" aria-label="Check my reading comprehension answers">Check My Answers</button>
                        <div class="results-display" id="reading-results" role="status" aria-live="polite"></div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">‚úçÔ∏è</span>Creative Writing Workshop</h2>
                <div class="writing-activities">
                    <div class="writing-prompt-container">
                        <h3>Story Starters</h3>
                        <div class="prompt-selector">
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('adventure', this)">Adventure</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('mystery', this)">Mystery</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('friendship', this)">Friendship</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('fantasy', this)">Fantasy</button>
                        </div>
                        
                        <div class="current-prompt" id="writing-prompt">
                            <h4>üåü Your Writing Prompt</h4>
                            <p id="prompt-text">Click a category above to get your story starter!</p>
                        </div>
                    </div>
                    
                    <div class="writing-editor">
                        <h3>üìù Your Story</h3>
                        <div class="writing-tools">
                            <button type="button" class="tool-btn" onclick="addDialogue()">üí¨ Add Dialogue</button>
                            <button type="button" class="tool-btn" onclick="addDescription()">üé® Add Description</button>
                            <button type="button" class="tool-btn" onclick="showWritingTips()">üí° Writing Tips</button>
                            <button type="button" class="tool-btn" onclick="saveStory()">üíæ Save Story</button>
                        </div>
                        
                        <textarea id="story-editor" placeholder="Start writing your story here..." rows="12"></textarea>
                        
                        <div class="word-counter">
                            <span id="word-count">0</span> words | <span id="char-count">0</span> characters
                        </div>
                        
                        <div class="writing-feedback" id="writing-feedback"></div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">üéØ</span>Grammar & Language Skills</h2>
                <div class="grammar-activities">
                    <div class="grammar-game-container">
                        <h3>Grammar Detective Game</h3>
                        <div class="game-selector">
                            <button type="button" class="game-btn" onclick="startGrammarGame('punctuation', this)">Punctuation Police</button>
                            <button type="button" class="game-btn" onclick="startGrammarGame('parts-of-speech', this)">Parts of Speech</button>
                            <button type="button" class="game-btn" onclick="startGrammarGame('sentence-structure', this)">Sentence Builder</button>
                        </div>
                        
                        <div class="grammar-game" id="grammar-game">
                            <div class="game-instructions" id="game-instructions">
                                <p>Choose a grammar game above to start practicing!</p>
                            </div>
                            
                            <div class="game-content" id="game-content">
                                <!-- Game content will be loaded here -->
                            </div>
                            
                            <div class="game-score" id="game-score"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">üìñ</span>Vocabulary Builder</h2>
                <div class="vocabulary-activities">
                    <div class="vocab-explorer">
                        <h3>Word Explorer</h3>
                        <div class="vocab-categories">
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('emotions', this)">üòä Emotions</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('nature', this)">üå≥ Nature</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('adventure', this)">üó∫Ô∏è Adventure</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('descriptive', this)">üé® Descriptive</button>
                        </div>
                        
                        <div class="vocab-display" id="vocab-display">
                            <div class="vocab-card-container" id="vocab-cards">
                                <p>Select a category to explore new words!</p>
                            </div>
                        </div>
                        
                        <div class="vocab-practice" id="vocab-practice">
                            <button type="button" class="practice-btn" onclick="startVocabQuiz()">üß† Test Your Knowledge</button>
                            <button type="button" class="practice-btn" onclick="createWordStory()">üìö Use Words in Story</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chapter-navigation">
            <a href="index.html" class="nav-button" aria-label="Previous: English overview">‚Üê Previous</a>
            <div class="progress-indicator">
                <div class="progress-bar"><div class="progress-fill" style="width: 10%"></div></div>
                <span class="progress-text">Chapter 1 Progress: 10%</span>
            </div>
            <a href="chapter-2.html" class="nav-button" aria-label="Next: Chapter 2 Writing & Composition">Next ‚Üí</a>
        </div>
    </main>
    <div id="footer-container"></div>
    
    <!-- Epic 7 JavaScript Systems -->
    <script src="../../js/app.js" defer></script>
    <script src="../../js/drag-drop-utils.js" defer></script>
    <script src="../../js/assessment-system.js" defer></script>
    <script src="../../js/multimedia-system.js" defer></script>
    <script src="../../js/gamification-system.js" defer></script>
    
    <script>
        function loadSharedComponents() {
            fetch('../shared/header.html').then(r => r.text()).then(h => document.getElementById('header-container').innerHTML = h);
            fetch('../shared/footer.html').then(r => r.text()).then(h => document.getElementById('footer-container').innerHTML = h);
        }
        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', loadSharedComponents) : loadSharedComponents();

        // Reading Comprehension System
        let readingTimer = 0;
        let timerInterval = null;
        let currentPassage = 'adventure';

        const readingPassages = {
            adventure: {
                title: 'The Great Adventure',
                text: `<p>Sarah had always dreamed of exploring the mysterious forest behind her grandmother's house. The towering trees seemed to whisper secrets, and the winding paths promised exciting discoveries. One sunny morning, she finally gathered the courage to venture into the unknown wilderness.</p>
                      <p>As she walked deeper into the forest, Sarah noticed how the sunlight filtered through the leaves, creating dancing shadows on the forest floor. She heard the cheerful chirping of birds and the gentle rustling of leaves in the breeze. The air smelled fresh and earthy, filled with the scent of pine needles and wildflowers.</p>
                      <p>Suddenly, Sarah spotted something unusual. A small, wooden door was carved into the trunk of an enormous oak tree. Her heart raced with excitement as she approached the mysterious entrance. What adventures awaited her on the other side?</p>`,
                questions: [
                    { q: 'What had Sarah always dreamed of doing?', options: ['Climbing mountains', 'Exploring the forest', 'Swimming in the lake', 'Building a treehouse'], correct: 1 },
                    { q: 'How did Sarah feel when she found the wooden door?', options: ['Scared and worried', 'Bored and tired', 'Excited and curious', 'Angry and frustrated'], correct: 2 },
                    { q: 'What sensory details does the author use to describe the forest?', options: ['Only what Sarah could see', 'Only what Sarah could hear', 'Sight, sound, and smell', 'Only what Sarah could touch'], correct: 2 }
                ]
            },
            friendship: {
                title: 'True Friendship',
                text: `<p>Maya and Alex had been best friends since kindergarten. They shared everything - their favorite snacks, their deepest secrets, and their wildest dreams. When Maya's family announced they were moving to another state, both friends felt their world turning upside down.</p>
                      <p>"Promise we'll stay friends forever," Maya whispered as they sat under their favorite oak tree. Alex nodded, fighting back tears. They spent their last day together creating a time capsule filled with photos, letters, and small treasures from their adventures.</p>
                      <p>Years passed, and despite the distance, Maya and Alex kept their promise. They wrote letters, made video calls, and visited each other during summers. Their friendship proved that true bonds can survive any challenge, growing stronger with time and trust.</p>`,
                questions: [
                    { q: 'How long had Maya and Alex been friends?', options: ['One year', 'Since kindergarten', 'Two years', 'Since first grade'], correct: 1 },
                    { q: 'What did they create on their last day together?', options: ['A photo album', 'A time capsule', 'A scrapbook', 'A video'], correct: 1 },
                    { q: 'What does this story teach us about friendship?', options: ['Friends must live nearby', 'Distance can end friendships', 'True friendship survives challenges', 'Making new friends is easy'], correct: 2 }
                ]
            },
            mystery: {
                title: 'The Missing Key',
                text: `<p>Detective Emma examined the locked treasure chest in the old library attic. The brass keyhole gleamed mysteriously in the dusty sunlight. According to the librarian, the chest had been there for over fifty years, and no one knew what secrets it held inside.</p>
                      <p>Emma searched carefully through old books and papers, looking for clues. In a forgotten diary, she discovered a riddle: "Where knowledge sleeps and stories wake, the key rests where readers partake." Her eyes lit up with understanding as she decoded the mysterious message.</p>
                      <p>Racing downstairs to the reading room, Emma found a loose brick near the fireplace where people often gathered to read. Inside the hidden space was an ornate brass key. With trembling hands, she returned to unlock the chest, revealing a collection of rare books and handwritten stories from children who had visited the library decades ago.</p>`,
                questions: [
                    { q: 'Where did Emma find the treasure chest?', options: ['In the basement', 'In the library attic', 'In the reading room', 'Outside the library'], correct: 1 },
                    { q: 'What helped Emma solve the mystery?', options: ['A map', 'A riddle in a diary', 'The librarian', 'A witness'], correct: 1 },
                    { q: 'What was inside the treasure chest?', options: ['Gold coins', 'Old photographs', 'Rare books and stories', 'Ancient artifacts'], correct: 2 }
                ]
            },
            nature: {
                title: 'Exploring Nature',
                text: `<p>The nature trail wound through a magnificent forest ecosystem. Tall evergreen trees stretched toward the sky, while colorful wildflowers carpeted the forest floor. A crystal-clear stream bubbled nearby, providing fresh water for the diverse wildlife that called this place home.</p>
                      <p>Quietly observing from the trail, visitors could spot red squirrels gathering acorns, graceful deer stepping carefully through the underbrush, and various bird species building their nests in the protective canopy above. Each creature played an important role in maintaining the forest's delicate balance.</p>
                      <p>The interconnected web of life fascinated young explorers who learned that every plant and animal depended on the others for survival. From the smallest insects pollinating flowers to the largest trees providing shelter, nature demonstrated the beauty and importance of working together in harmony.</p>`,
                questions: [
                    { q: 'What provides water for the forest wildlife?', options: ['Rain puddles', 'A crystal-clear stream', 'Underground springs', 'Morning dew'], correct: 1 },
                    { q: 'According to the passage, what do red squirrels gather?', options: ['Berries', 'Leaves', 'Acorns', 'Twigs'], correct: 2 },
                    { q: 'What is the main message about nature in this passage?', options: ['Animals are dangerous', 'Plants grow everywhere', 'All living things work together', 'Forests are quiet places'], correct: 2 }
                ]
            }
        };

        function loadReadingPassage() {
            const select = document.getElementById('passage-select');
            currentPassage = select.value;
            const passage = readingPassages[currentPassage];
            
            document.getElementById('passage-title').textContent = passage.title;
            document.getElementById('passage-text').innerHTML = passage.text;
            
            // Load questions
            const questionsContainer = document.getElementById('comprehension-questions');
            let questionsHTML = '<h4>üìù Reading Comprehension Questions</h4><div class="question-container">';
            
            passage.questions.forEach((question, index) => {
                questionsHTML += `
                    <div class="question" data-question="${index + 1}">
                        <p><strong>${index + 1}. ${question.q}</strong></p>
                        <div class="answer-options">
                            ${question.options.map((option, i) => 
                                `<label><input type="radio" name="q${index + 1}" value="${i}"> ${option}</label>`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            
            questionsHTML += '</div><button type="button" class="check-answers-btn" onclick="checkReadingAnswers()" aria-label="Check my reading comprehension answers">Check My Answers</button><div class="results-display" id="reading-results" role="status" aria-live="polite"></div>';
            questionsContainer.innerHTML = questionsHTML;
            
            // Reset timer
            readingTimer = 0;
            updateTimer();
            startReadingTimer();
        }

        function startReadingTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                readingTimer++;
                updateTimer();
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(readingTimer / 60);
            const seconds = readingTimer % 60;
            document.getElementById('reading-timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkReadingAnswers() {
            if (timerInterval) clearInterval(timerInterval);
            
            const passage = readingPassages[currentPassage];
            let score = 0;
            const results = [];
            
            passage.questions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index + 1}"]:checked`);
                if (selected) {
                    if (parseInt(selected.value) === question.correct) {
                        score++;
                        results.push(`‚úÖ Question ${index + 1}: Correct!`);
                    } else {
                        results.push(`‚ùå Question ${index + 1}: Incorrect. The correct answer is "${question.options[question.correct]}"`);
                    }
                } else {
                    results.push(`‚ö†Ô∏è Question ${index + 1}: No answer selected`);
                }
            });
            
            const percentage = Math.round((score / passage.questions.length) * 100);
            let feedback = '';
            if (percentage >= 90) feedback = 'Excellent work! üåü';
            else if (percentage >= 70) feedback = 'Good job! üëç';
            else if (percentage >= 50) feedback = 'Keep practicing! üìö';
            else feedback = 'Need more practice. Try again! üí™';
            
            document.getElementById('reading-results').innerHTML = `
                <h4>Your Results</h4>
                <p><strong>Score: ${score}/${passage.questions.length} (${percentage}%)</strong></p>
                <p><strong>${feedback}</strong></p>
                <p><strong>Reading Time: ${Math.floor(readingTimer / 60)}:${(readingTimer % 60).toString().padStart(2, '0')}</strong></p>
                <div class="answer-details">${results.join('<br>')}</div>
            `;
        }

        // Creative Writing System
        const writingPrompts = {
            adventure: [
                "You discover a hidden cave behind a waterfall. What treasures await inside?",
                "Your pet suddenly starts talking and asks you to go on a quest. Where do you go?",
                "You find a mysterious map in your attic. Where does it lead?",
                "A friendly dragon offers to take you on a flight around the world. Describe your journey."
            ],
            mystery: [
                "All the clocks in your town have stopped at exactly 3:33. What's happening?",
                "You receive a letter addressed to someone from 100 years ago. What do you do?",
                "Your shadow starts acting independently. What is it trying to tell you?",
                "A new student at school seems to know things they shouldn't. What's their secret?"
            ],
            friendship: [
                "Your best friend moves away, but you discover a magical way to visit them. How?",
                "Two very different animals become unlikely friends. Tell their story.",
                "You have the power to bring two people together. Who do you choose and why?",
                "A shy new student sits alone at lunch. How do you help them make friends?"
            ],
            fantasy: [
                "You wake up with magical powers, but they only work when you're helping others.",
                "A talking tree in your backyard offers to grant you one wish. What do you choose?",
                "You're invited to attend a school for young wizards. Describe your first day.",
                "A constellation falls from the sky and becomes your companion. What adventures follow?"
            ]
        };

        function selectWritingPrompt(category, triggerEl) {
            const prompts = writingPrompts[category];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('prompt-text').textContent = randomPrompt;
            
            // Update button styles
            const buttons = document.querySelectorAll('.prompt-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${category}'`) || handler.includes(`\"${category}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function addDialogue() {
            const editor = document.getElementById('story-editor');
            const sampleDialogue = '\n\n"Hello there!" said [Character Name]. "How are you feeling today?"\n\n"I\'m excited about our adventure," replied [Other Character].\n\n';
            editor.value += sampleDialogue;
            updateWordCount();
        }

        function addDescription() {
            const editor = document.getElementById('story-editor');
            const sampleDescription = '\n\nThe [setting] was [adjective] and [adjective]. [Character] could [action] while [sensory detail]. It felt like [comparison or metaphor].\n\n';
            editor.value += sampleDescription;
            updateWordCount();
        }

        function showWritingTips() {
            const tips = [
                "Use descriptive words to paint a picture in the reader's mind.",
                "Start your story with action or dialogue to grab attention.",
                "Show don't tell - instead of 'he was scared', write 'his hands trembled'.",
                "Use the five senses: sight, sound, smell, taste, and touch.",
                "Give your characters unique personalities and speaking styles.",
                "Create a clear beginning, middle, and end for your story."
            ];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('writing-feedback').innerHTML = `<div class="writing-tip">üí° <strong>Writing Tip:</strong> ${randomTip}</div>`;
        }

        function updateWordCount() {
            const editor = document.getElementById('story-editor');
            const text = editor.value;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const characters = text.length;
            
            document.getElementById('word-count').textContent = words;
            document.getElementById('char-count').textContent = characters;
        }

        function saveStory() {
            const story = document.getElementById('story-editor').value;
            if (story.trim() === '') {
                alert('Please write something before saving!');
                return;
            }
            
            const blob = new Blob([story], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my-story-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('writing-feedback').innerHTML = '<div class="success-message">üìù Your story has been saved successfully!</div>';
        }

        // Epic 7 Multimedia Integration
        let multimediaSystem = null;
        let isNarrating = false;
        let isHighlighting = false;
        
        // Initialize multimedia system and word count tracking
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('story-editor');
            if (editor) {
                editor.addEventListener('input', updateWordCount);
                loadReadingPassage(); // Load initial passage
            }
            
            // Initialize multimedia system
            if (window.MultimediaSystem) {
                multimediaSystem = new MultimediaSystem({
                    autoPlay: false,
                    narrationRate: 0.9,
                    highlightColor: '#ffeb3b',
                    accessibility: true
                });
                
                // Award points for using multimedia features
                if (window.GamificationSystem) {
                    window.gamificationSystem.awardPoints('engagement_feature');
                }
            }
        });
        
        // Toggle narration functionality
        function toggleNarration() {
            if (!multimediaSystem) {
                alert('Multimedia system loading... Please try again in a moment.');
                return;
            }
            
            const btn = document.getElementById('narration-btn');
            const passageText = document.getElementById('passage-text').textContent;
            
            if (!isNarrating) {
                isNarrating = true;
                btn.innerHTML = '‚è∏Ô∏è Pause';
                btn.title = 'Pause narration';
                
                multimediaSystem.startNarration(passageText, {
                    rate: 0.9,
                    pitch: 1.0,
                    onEnd: () => {
                        isNarrating = false;
                        btn.innerHTML = 'üîä Listen';
                        btn.title = 'Listen to passage';
                        
                        // Award points for completing narration
                        if (window.GamificationSystem) {
                            window.gamificationSystem.awardPoints('narration_complete');
                        }
                    }
                });
                
                // Award points for using narration
                if (window.GamificationSystem) {
                    window.gamificationSystem.awardPoints('narration_start');
                }
            } else {
                isNarrating = false;
                btn.innerHTML = 'üîä Listen';
                btn.title = 'Listen to passage';
                multimediaSystem.stopNarration();
            }
        }
        
        // Toggle highlighting functionality
        function toggleHighlighting() {
            const btn = document.getElementById('highlight-btn');
            const passageText = document.getElementById('passage-text');
            
            if (!isHighlighting) {
                isHighlighting = true;
                btn.innerHTML = 'üéØ Stop Highlight';
                btn.title = 'Stop highlighting';
                
                // Add highlighting functionality
                passageText.style.cursor = 'pointer';
                passageText.addEventListener('click', highlightText);
                
                // Add instructional message
                passageText.insertAdjacentHTML('afterbegin', 
                    '<div id="highlight-instruction" style="background: #e3f2fd; padding: 0.5rem; margin-bottom: 1rem; border-radius: 0.25rem; font-size: 0.9rem;">üëÜ Click on any sentence to highlight it!</div>'
                );
                
                // Award points for using highlighting
                if (window.GamificationSystem) {
                    window.gamificationSystem.awardPoints('highlighting_start');
                }
            } else {
                isHighlighting = false;
                btn.innerHTML = '‚ú® Highlight';
                btn.title = 'Highlight as you read';
                
                passageText.style.cursor = 'default';
                passageText.removeEventListener('click', highlightText);
                
                // Remove highlights and instruction
                const instruction = document.getElementById('highlight-instruction');
                if (instruction) instruction.remove();
                
                passageText.querySelectorAll('.highlighted-text').forEach(element => {
                    element.style.backgroundColor = '';
                    element.classList.remove('highlighted-text');
                });
            }
        }
        
        // Highlight clicked text
        function highlightText(event) {
            if (event.target.tagName === 'P') {
                if (event.target.classList.contains('highlighted-text')) {
                    event.target.style.backgroundColor = '';
                    event.target.classList.remove('highlighted-text');
                } else {
                    event.target.style.backgroundColor = '#ffeb3b';
                    event.target.classList.add('highlighted-text');
                    
                    // Award points for highlighting
                    if (window.GamificationSystem) {
                        window.gamificationSystem.awardPoints('text_highlight');
                    }
                }
            }
        }

        // Grammar Games System
        let currentGrammarGame = null;
        let gameScore = 0;
        let questionsAnswered = 0;

        const grammarGames = {
            punctuation: {
                name: 'Punctuation Police',
                instructions: 'Help fix these sentences by choosing the correct punctuation!',
                questions: [
                    { sentence: 'What time is it', options: ['?', '!', '.', ','], correct: 0, explanation: 'Questions end with question marks.' },
                    { sentence: 'Watch out', options: ['?', '!', '.', ','], correct: 1, explanation: 'Exclamations showing strong emotion end with exclamation points.' },
                    { sentence: 'I like pizza, hamburgers and ice cream', options: [' and ice cream.', ', and ice cream.', ' and, ice cream.', ', and, ice cream.'], correct: 1, explanation: 'Use commas to separate items in a series.' },
                    { sentence: 'My favorite colors are blue green and yellow', options: [' blue green and', ' blue, green, and', ' blue green, and', ' blue, green and'], correct: 1, explanation: 'Use commas between all items in a series.' }
                ]
            },
            'parts-of-speech': {
                name: 'Parts of Speech Detective',
                instructions: 'Identify the part of speech for the highlighted word!',
                questions: [
                    { sentence: 'The *happy* dog ran quickly.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 2, explanation: 'Happy describes the dog, so it\'s an adjective.' },
                    { sentence: 'She *ran* to the store.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 1, explanation: 'Ran is an action word, so it\'s a verb.' },
                    { sentence: 'The cat sat on the *table*.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 0, explanation: 'Table is a person, place, or thing, so it\'s a noun.' },
                    { sentence: 'He spoke very *softly*.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 3, explanation: 'Softly describes how he spoke, so it\'s an adverb.' }
                ]
            },
            'sentence-structure': {
                name: 'Sentence Builder',
                instructions: 'Choose the words that make a complete sentence!',
                questions: [
                    { prompt: 'Which is a complete sentence?', options: ['Running in the park.', 'The dog barked loudly.', 'After the rain stopped.', 'Because I was tired.'], correct: 1, explanation: 'A complete sentence needs a subject and a predicate.' },
                    { prompt: 'What type of sentence is: "Close the door."', options: ['Statement', 'Question', 'Command', 'Exclamation'], correct: 2, explanation: 'This gives a command or instruction.' },
                    { prompt: 'Which sentence is a question?', options: ['I love reading books.', 'What is your favorite book.', 'What is your favorite book?', 'Read this book!'], correct: 2, explanation: 'Questions end with question marks.' },
                    { prompt: 'What makes this sentence exciting: "Wow, what a great game!"', options: ['Question mark', 'Exclamation point', 'Period', 'Comma'], correct: 1, explanation: 'Exclamation points show strong emotion or excitement.' }
                ]
            }
        };

        function startGrammarGame(gameType, triggerEl) {
            currentGrammarGame = gameType;
            gameScore = 0;
            questionsAnswered = 0;
            
            const game = grammarGames[gameType];
            document.getElementById('game-instructions').innerHTML = `
                <h4>${game.name}</h4>
                <p>${game.instructions}</p>
            `;
            
            loadGrammarQuestion(0);
            
            // Update button styles
            const buttons = document.querySelectorAll('.game-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${gameType}'`) || handler.includes(`\"${gameType}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function loadGrammarQuestion(questionIndex) {
            const game = grammarGames[currentGrammarGame];
            if (questionIndex >= game.questions.length) {
                showGrammarResults();
                return;
            }
            
            const question = game.questions[questionIndex];
            let questionHTML = '';
            
            if (question.sentence) {
                questionHTML = `
                    <div class="grammar-question">
                        <h4>Question ${questionIndex + 1} of ${game.questions.length}</h4>
                        <p class="sentence">${question.sentence.replace(/\*/g, '<strong>')}</p>
                        <div class="grammar-options">
                            ${question.options.map((option, i) => 
                                `<button type="button" class="option-btn" onclick="selectGrammarAnswer(${questionIndex}, ${i})">${option}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                questionHTML = `
                    <div class="grammar-question">
                        <h4>Question ${questionIndex + 1} of ${game.questions.length}</h4>
                        <p class="prompt">${question.prompt}</p>
                        <div class="grammar-options">
                            ${question.options.map((option, i) => 
                                `<button type="button" class="option-btn" onclick="selectGrammarAnswer(${questionIndex}, ${i})">${option}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('game-content').innerHTML = questionHTML;
        }

        function selectGrammarAnswer(questionIndex, selectedAnswer) {
            const game = grammarGames[currentGrammarGame];
            const question = game.questions[questionIndex];
            
            questionsAnswered++;
            let feedback = '';
            
            if (selectedAnswer === question.correct) {
                gameScore++;
                feedback = `<div class="correct-answer">‚úÖ Correct! ${question.explanation}</div>`;
            } else {
                feedback = `<div class="incorrect-answer">‚ùå Incorrect. ${question.explanation}</div>`;
            }
            
            document.getElementById('game-content').innerHTML += feedback;
            
            setTimeout(() => {
                loadGrammarQuestion(questionIndex + 1);
            }, 2000);
        }

        function showGrammarResults() {
            const percentage = Math.round((gameScore / questionsAnswered) * 100);
            let message = '';
            
            if (percentage >= 90) message = 'Outstanding grammar skills! üåü';
            else if (percentage >= 70) message = 'Great job! Keep it up! üëç';
            else if (percentage >= 50) message = 'Good effort! Practice more! üìö';
            else message = 'Keep studying! You\'ll improve! üí™';
            
            document.getElementById('game-score').innerHTML = `
                <h4>Game Complete!</h4>
                <p><strong>Final Score: ${gameScore}/${questionsAnswered} (${percentage}%)</strong></p>
                <p>${message}</p>
                <button type="button" class="play-again-btn" onclick="startGrammarGame('${currentGrammarGame}')">Play Again</button>
            `;
        }

        // Vocabulary System
        const vocabularyCategories = {
            emotions: {
                name: 'Emotions & Feelings',
                words: [
                    { word: 'Elated', definition: 'Extremely happy and excited', example: 'She felt elated when she won the contest.' },
                    { word: 'Melancholy', definition: 'A gentle sadness', example: 'The rainy day made him feel melancholy.' },
                    { word: 'Serene', definition: 'Calm and peaceful', example: 'The lake looked serene in the morning.' },
                    { word: 'Bewildered', definition: 'Very confused', example: 'He was bewildered by the difficult math problem.' },
                    { word: 'Triumphant', definition: 'Feeling successful and proud', example: 'The team felt triumphant after their victory.' }
                ]
            },
            nature: {
                name: 'Nature & Environment',
                words: [
                    { word: 'Majestic', definition: 'Grand and impressive', example: 'The majestic mountains towered above the valley.' },
                    { word: 'Lush', definition: 'Rich and abundant in growth', example: 'The lush garden was full of colorful flowers.' },
                    { word: 'Pristine', definition: 'In perfect, untouched condition', example: 'The pristine lake reflected the sky perfectly.' },
                    { word: 'Vibrant', definition: 'Full of life and bright color', example: 'The vibrant sunset painted the sky orange and pink.' },
                    { word: 'Tranquil', definition: 'Quiet and peaceful', example: 'The forest was tranquil in the early morning.' }
                ]
            },
            adventure: {
                name: 'Adventure & Exploration',
                words: [
                    { word: 'Intrepid', definition: 'Brave and fearless', example: 'The intrepid explorer ventured into the unknown cave.' },
                    { word: 'Perilous', definition: 'Full of danger', example: 'The mountain climb was perilous but exciting.' },
                    { word: 'Treacherous', definition: 'Dangerous and unpredictable', example: 'The treacherous path led through the dark forest.' },
                    { word: 'Valiant', definition: 'Courageous and determined', example: 'The valiant knight rescued the villagers.' },
                    { word: 'Audacious', definition: 'Bold and daring', example: 'Her audacious plan surprised everyone.' }
                ]
            },
            descriptive: {
                name: 'Descriptive Words',
                words: [
                    { word: 'Luminous', definition: 'Giving off bright light', example: 'The luminous stars lit up the night sky.' },
                    { word: 'Colossal', definition: 'Extremely large', example: 'The colossal statue dominated the town square.' },
                    { word: 'Minuscule', definition: 'Extremely small', example: 'The minuscule ant carried a crumb twice its size.' },
                    { word: 'Gleaming', definition: 'Shining brightly', example: 'The knight\'s gleaming armor caught the sunlight.' },
                    { word: 'Ornate', definition: 'Decorated with fancy details', example: 'The ornate doorway was covered in carved flowers.' }
                ]
            }
        };

        let currentVocabCategory = null;
        let vocabQuizMode = false;

        function loadVocabCategory(category, triggerEl) {
            currentVocabCategory = category;
            const vocab = vocabularyCategories[category];
            
            let cardsHTML = `<h4>${vocab.name}</h4><div class="vocab-cards">`;
            vocab.words.forEach((wordObj, index) => {
                cardsHTML += `
                    <div class="vocab-card" onclick="flipVocabCard(${index})">
                        <div class="card-front">
                            <h3>${wordObj.word}</h3>
                            <p class="tap-hint">Tap to see definition</p>
                        </div>
                        <div class="card-back" id="card-back-${index}" style="display: none;">
                            <h3>${wordObj.word}</h3>
                            <p class="definition"><strong>Definition:</strong> ${wordObj.definition}</p>
                            <p class="example"><strong>Example:</strong> ${wordObj.example}</p>
                        </div>
                    </div>
                `;
            });
            cardsHTML += '</div>';
            
            document.getElementById('vocab-cards').innerHTML = cardsHTML;
            
            // Update button styles
            const buttons = document.querySelectorAll('.vocab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${category}'`) || handler.includes(`\"${category}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function flipVocabCard(index) {
            const front = document.querySelector(`#vocab-cards .vocab-card:nth-child(${index + 2}) .card-front`);
            const back = document.querySelector(`#vocab-cards .vocab-card:nth-child(${index + 2}) .card-back`);
            
            if (front.style.display !== 'none') {
                front.style.display = 'none';
                back.style.display = 'block';
            } else {
                front.style.display = 'block';
                back.style.display = 'none';
            }
        }

        function startVocabQuiz() {
            if (!currentVocabCategory) {
                alert('Please select a vocabulary category first!');
                return;
            }
            
            const vocab = vocabularyCategories[currentVocabCategory];
            const randomWord = vocab.words[Math.floor(Math.random() * vocab.words.length)];
            const allWords = Object.values(vocabularyCategories).flatMap(cat => cat.words);
            
            // Create wrong options
            const wrongOptions = allWords
                .filter(w => w.word !== randomWord.word)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3)
                .map(w => w.definition);
            
            const options = [randomWord.definition, ...wrongOptions].sort(() => 0.5 - Math.random());
            const correctIndex = options.indexOf(randomWord.definition);
            
            let quizHTML = `
                <h4>Vocabulary Quiz</h4>
                <div class="vocab-quiz">
                    <p class="quiz-word"><strong>What does "${randomWord.word}" mean?</strong></p>
                    <div class="quiz-options">
                        ${options.map((option, i) => 
                            `<button type="button" class="quiz-option-btn" onclick="checkVocabAnswer(${i}, ${correctIndex}, '${randomWord.word}', '${randomWord.example}')">${option}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('vocab-cards').innerHTML = quizHTML;
        }

        function checkVocabAnswer(selected, correct, word, example) {
            let result = '';
            if (selected === correct) {
                result = `<div class="vocab-correct">‚úÖ Correct! "${word}" is used like this: ${example}</div>`;
            } else {
                result = `<div class="vocab-incorrect">‚ùå Incorrect. Try again!</div>`;
            }
            
            document.querySelector('.vocab-quiz').innerHTML += result;
            
            setTimeout(() => {
                if (selected === correct) {
                    loadVocabCategory(currentVocabCategory);
                }
            }, 3000);
        }

        function createWordStory() {
            if (!currentVocabCategory) {
                alert('Please select a vocabulary category first!');
                return;
            }
            
            const vocab = vocabularyCategories[currentVocabCategory];
            const wordList = vocab.words.map(w => w.word).join(', ');
            
            document.getElementById('story-editor').value = 
                `Write a short story using these vocabulary words: ${wordList}\n\n` +
                'Remember to use each word correctly based on its definition. Make your story creative and fun!\n\n' +
                'Your story:\n\n';
            
            // Scroll to writing section
            document.querySelector('.writing-editor').scrollIntoView({ behavior: 'smooth' });
            updateWordCount();
        }
    </script>
</body>
</html>

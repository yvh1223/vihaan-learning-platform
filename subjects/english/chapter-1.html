<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 1 - English Language Arts</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/responsive.css">
</head>
<body>
    <div id="header-container"></div>
    <main class="chapter-container" id="main-content">
        <div class="chapter-header">
            <div class="chapter-number">Chapter 1</div>
            <h1 class="chapter-title">Reading & Writing Fundamentals</h1>
        </div>
        <div class="lesson-content">
            <div class="lesson-section">
                <h2><span class="section-icon">üìö</span>Reading Comprehension & Analysis</h2>
                <div class="reading-passage-container">
                    <div class="passage-selector">
                        <label for="passage-select">Choose a Reading Passage:</label>
                        <select id="passage-select" onchange="loadReadingPassage()">
                            <option value="adventure">The Great Adventure</option>
                            <option value="friendship">True Friendship</option>
                            <option value="mystery">The Missing Key</option>
                            <option value="nature">Exploring Nature</option>
                        </select>
                    </div>
                    
                    <div class="reading-passage" id="reading-passage">
                        <div class="passage-header">
                            <h3 id="passage-title">The Great Adventure</h3>
                            <div class="reading-controls">
                                <div class="reading-timer">
                                    <span class="timer-icon">‚è±Ô∏è</span>
                                    <span id="reading-timer">0:00</span>
                                </div>
                                <button type="button" id="narration-btn" class="narration-button" onclick="toggleNarration()" title="Listen to passage" aria-pressed="false">
                                    üîä Listen
                                </button>
                                <button type="button" id="highlight-btn" class="highlight-button" onclick="toggleHighlighting()" title="Highlight as you read" aria-pressed="false">
                                    ‚ú® Highlight
                                </button>
                            </div>
                        </div>
                        <div class="passage-text" id="passage-text" aria-live="polite">
                            <p>Sarah had traced the edge of the forest on her map so many times that the paper was soft at the folds. Today, she finally packed a notebook, a pencil, and a pocket compass, then stepped past the last fence post behind her grandmother's garden. The trees closed around her like a secret, and the air felt cooler and full of promise.</p>

                            <p>The path twisted under her feet, covered in needles that smelled sharp and clean. Sunlight spilled through the branches in golden stripes. She heard a woodpecker tapping somewhere above and the slow rush of a creek nearby. Sarah paused to sketch a fern, then noticed a line of tiny footprints leading toward the oldest oak she had ever seen.</p>

                            <p>At the base of the oak, a small wooden door was carved into the bark, its handle shaped like a leaf. A faint breeze slipped out from the crack, carrying a warm, cinnamon scent. Sarah's heart thumped. She placed her palm on the handle and wondered what story might begin the moment it opened.</p>
                        </div>
                    </div>
                    
                    <div class="comprehension-questions" id="comprehension-questions" role="region" aria-labelledby="reading-questions-title">
                        <h4 id="reading-questions-title">üìù Reading Comprehension Questions</h4>
                        <div class="question-container">
                            <div class="question" data-question="1">
                                <p><strong>1. What detail shows Sarah prepared for her adventure?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q1" value="0"> She wore a new jacket</label>
                                    <label><input type="radio" name="q1" value="1"> She packed a notebook, pencil, and compass</label>
                                    <label><input type="radio" name="q1" value="2"> She brought her bicycle</label>
                                    <label><input type="radio" name="q1" value="3"> She waited for a friend</label>
                                </div>
                            </div>
                            
                            <div class="question" data-question="2">
                                <p><strong>2. Which sentence best describes the forest atmosphere?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q2" value="0"> Loud and crowded</label>
                                    <label><input type="radio" name="q2" value="1"> Cool, quiet, and full of promise</label>
                                    <label><input type="radio" name="q2" value="2"> Hot and dusty</label>
                                    <label><input type="radio" name="q2" value="3"> Stormy and dangerous</label>
                                </div>
                            </div>
                            
                            <div class="question" data-question="3">
                                <p><strong>3. What clue hints the door leads to something unusual?</strong></p>
                                <div class="answer-options">
                                    <label><input type="radio" name="q3" value="0"> The handle was shaped like a leaf</label>
                                    <label><input type="radio" name="q3" value="1"> The sun was bright</label>
                                    <label><input type="radio" name="q3" value="2"> There were ferns on the path</label>
                                    <label><input type="radio" name="q3" value="3"> Sarah had a pencil</label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="check-answers-btn" onclick="checkReadingAnswers()" aria-label="Check my reading comprehension answers">Check My Answers</button>
                        <div class="results-display" id="reading-results" role="status" aria-live="polite"></div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">‚úçÔ∏è</span>Creative Writing Workshop</h2>
                <div class="writing-activities">
                    <div class="writing-prompt-container">
                        <h3>Story Starters</h3>
                        <div class="prompt-selector">
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('adventure', this)">Adventure</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('mystery', this)">Mystery</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('friendship', this)">Friendship</button>
                            <button type="button" class="prompt-btn" onclick="selectWritingPrompt('fantasy', this)">Fantasy</button>
                        </div>
                        
                        <div class="current-prompt" id="writing-prompt">
                            <h4>üåü Your Writing Prompt</h4>
                            <p id="prompt-text">Click a category above to get your story starter!</p>
                        </div>
                    </div>
                    
                    <div class="writing-editor">
                        <h3>üìù Your Story</h3>
                        <div class="writing-tools">
                            <button type="button" class="tool-btn" onclick="addDialogue()">üí¨ Add Dialogue</button>
                            <button type="button" class="tool-btn" onclick="addDescription()">üé® Add Description</button>
                            <button type="button" class="tool-btn" onclick="showWritingTips()">üí° Writing Tips</button>
                            <button type="button" class="tool-btn" onclick="saveStory()">üíæ Save Story</button>
                        </div>
                        
                        <textarea id="story-editor" placeholder="Start writing your story here..." rows="12" aria-label="Story editor"></textarea>
                        
                        <div class="word-counter">
                            <span id="word-count">0</span> words | <span id="char-count">0</span> characters
                        </div>
                        
                        <div class="writing-feedback" id="writing-feedback" role="status" aria-live="polite"></div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">üéØ</span>Grammar & Language Skills</h2>
                <div class="grammar-activities">
                    <div class="grammar-game-container">
                        <h3>Grammar Detective Game</h3>
                        <div class="game-selector">
                            <button type="button" class="game-btn" onclick="startGrammarGame('punctuation', this)">Punctuation Police</button>
                            <button type="button" class="game-btn" onclick="startGrammarGame('parts-of-speech', this)">Parts of Speech</button>
                            <button type="button" class="game-btn" onclick="startGrammarGame('sentence-structure', this)">Sentence Builder</button>
                        </div>
                        
                        <div class="grammar-game" id="grammar-game">
                            <div class="game-instructions" id="game-instructions">
                                <p>Choose a grammar game above to start practicing!</p>
                            </div>
                            
                            <div class="game-content" id="game-content" aria-live="polite">
                                <!-- Game content will be loaded here -->
                            </div>
                            
                            <div class="game-score" id="game-score" role="status" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lesson-section">
                <h2><span class="section-icon">üìñ</span>Vocabulary Builder</h2>
                <div class="vocabulary-activities">
                    <div class="vocab-explorer">
                        <h3>Word Explorer</h3>
                        <div class="vocab-categories">
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('emotions', this)">üòä Emotions</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('nature', this)">üå≥ Nature</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('adventure', this)">üó∫Ô∏è Adventure</button>
                            <button type="button" class="vocab-btn" onclick="loadVocabCategory('descriptive', this)">üé® Descriptive</button>
                        </div>
                        
                        <div class="vocab-display" id="vocab-display">
                            <div class="vocab-card-container" id="vocab-cards" aria-live="polite">
                                <p>Select a category to explore new words!</p>
                            </div>
                        </div>
                        
                        <div class="vocab-practice" id="vocab-practice">
                            <button type="button" class="practice-btn" onclick="startVocabQuiz()">üß† Test Your Knowledge</button>
                            <button type="button" class="practice-btn" onclick="createWordStory()">üìö Use Words in Story</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chapter-navigation">
            <a href="index.html" class="nav-button" aria-label="Previous: English overview">‚Üê Previous</a>
            <div class="progress-indicator">
                <div class="progress-bar"><div class="progress-fill" style="width: 10%"></div></div>
                <span class="progress-text">Chapter 1 Progress: 10%</span>
            </div>
            <a href="chapter-2.html" class="nav-button" aria-label="Next: Chapter 2 Writing & Composition">Next ‚Üí</a>
        </div>
    </main>
    <div id="footer-container"></div>
    
    <!-- Epic 7 JavaScript Systems -->
    <script src="../../js/app.js" defer></script>
    <script src="../../js/drag-drop-utils.js" defer></script>
    <script src="../../js/assessment-system.js" defer></script>
    <script src="../../js/multimedia-system.js" defer></script>
    <script src="../../js/gamification-system.js" defer></script>
    
    <script>
        function loadSharedComponents() {
            fetch('../shared/header.html').then(r => r.text()).then(h => document.getElementById('header-container').innerHTML = h);
            fetch('../shared/footer.html').then(r => r.text()).then(h => document.getElementById('footer-container').innerHTML = h);
        }
        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', loadSharedComponents) : loadSharedComponents();

        // Reading Comprehension System
        let readingTimer = 0;
        let timerInterval = null;
        let currentPassage = 'adventure';

        const readingPassages = {
            adventure: {
                title: 'The Great Adventure',
                text: `<p>Sarah had traced the edge of the forest on her map so many times that the paper was soft at the folds. Today, she finally packed a notebook, a pencil, and a pocket compass, then stepped past the last fence post behind her grandmother's garden. The trees closed around her like a secret, and the air felt cooler and full of promise.</p>
                      <p>The path twisted under her feet, covered in needles that smelled sharp and clean. Sunlight spilled through the branches in golden stripes. She heard a woodpecker tapping somewhere above and the slow rush of a creek nearby. Sarah paused to sketch a fern, then noticed a line of tiny footprints leading toward the oldest oak she had ever seen.</p>
                      <p>At the base of the oak, a small wooden door was carved into the bark, its handle shaped like a leaf. A faint breeze slipped out from the crack, carrying a warm, cinnamon scent. Sarah's heart thumped. She placed her palm on the handle and wondered what story might begin the moment it opened.</p>`,
                questions: [
                    { q: 'What detail shows Sarah prepared for her adventure?', options: ['She wore a new jacket', 'She packed a notebook, pencil, and compass', 'She brought her bicycle', 'She waited for a friend'], correct: 1 },
                    { q: 'Which sentence best describes the forest atmosphere?', options: ['Loud and crowded', 'Cool, quiet, and full of promise', 'Hot and dusty', 'Stormy and dangerous'], correct: 1 },
                    { q: 'What clue hints the door leads to something unusual?', options: ['The handle was shaped like a leaf', 'The sun was bright', 'There were ferns on the path', 'Sarah had a pencil'], correct: 0 }
                ]
            },
            friendship: {
                title: 'True Friendship',
                text: `<p>Maya and Alex had been best friends since kindergarten, the kind of friends who could finish each other's sentences and laugh at the same silly jokes. When Maya's family announced they were moving to another state, the news felt like a door slowly closing.</p>
                      <p>On their last weekend together, they biked to their favorite hill and watched the sky turn pink. "Let's build something that keeps our memories safe," Alex said. They made a time capsule filled with photos, handwritten letters, a ticket stub from their first movie, and a tiny pinecone they once named Sir Prickles.</p>
                      <p>Distance didn't erase their friendship. They traded voice messages, mailed postcards, and kept a shared story journal where each added a new chapter. Their promise grew into a habit of showing up, proving that true friendship is built on care, not on miles.</p>`,
                questions: [
                    { q: "How are Maya and Alex's friendship described?", options: ['They only talk at school', "They can finish each other's sentences", 'They rarely agree', 'They just met this year'], correct: 1 },
                    { q: 'What special item did they include in the time capsule?', options: ['A trophy', 'A pinecone they named', 'A new bike bell', 'A map of the city'], correct: 1 },
                    { q: 'What helped their friendship stay strong?', options: ['Ignoring each other', 'Only visiting once', 'Sharing messages and a story journal', 'Never talking about feelings'], correct: 2 }
                ]
            },
            mystery: {
                title: 'The Missing Key',
                text: `<p>Detective Emma climbed into the library attic, where dust motes spun in the sunlight like tiny stars. In the corner sat a heavy wooden chest with a brass lock that hadn't been opened in decades. The librarian told her it had been discovered behind a wall after a renovation, but no one had found the key.</p>
                      <p>Emma searched for clues among the old records. In a diary tucked inside a cracked leather book, she read a riddle: "Where knowledge sleeps and stories wake, the key rests where readers partake." She pictured the reading room, the warm fireplace, and the brick ledge where students gathered with books.</p>
                      <p>Back downstairs, Emma felt along the bricks and found one that wobbled. Inside, a small brass key shimmered. When she unlocked the chest, she discovered a collection of handwritten stories from children long ago, each one labeled with a date and a dream.</p>`,
                questions: [
                    { q: 'Where did Emma find the chest?', options: ['In the library attic', 'Behind the fireplace', 'Under the stairs', 'In the basement'], correct: 0 },
                    { q: 'What clue guided Emma to the key?', options: ['A map', 'A riddle in a diary', 'A phone call', 'A hidden note on the door'], correct: 1 },
                    { q: 'What was revealed inside the chest?', options: ['Gold coins', 'Handwritten stories from children', 'Old uniforms', 'A missing painting'], correct: 1 }
                ]
            },
            nature: {
                title: 'Exploring Nature',
                text: `<p>The nature trail curled along a sparkling stream where dragonflies skimmed the water. Tall evergreens shaded the path while bright wildflowers leaned toward the sun. The air smelled like rain and pine, and the forest felt alive with quiet motion.</p>
                      <p>From a wooden lookout, visitors could spot red squirrels gathering acorns, deer moving softly through the ferns, and birds tucking twigs into their nests. The forest worked like a team--each creature had a job that helped the whole place stay healthy.</p>
                      <p>Young explorers learned that even the smallest insect mattered. Bees helped flowers grow. Fallen logs fed mushrooms. Roots held the soil in place. Nature showed them that balance happens when living things support one another.</p>`,
                questions: [
                    { q: 'Where do visitors stand to observe animals?', options: ['A wooden lookout', 'A tree house', 'A bridge', 'A cave'], correct: 0 },
                    { q: 'What do red squirrels gather?', options: ['Berries', 'Acorns', 'Leaves', 'Stones'], correct: 1 },
                    { q: "What is the passage's main message?", options: ['Forests are empty', 'Animals live alone', 'Living things support one another', 'Plants are dangerous'], correct: 2 }
                ]
            }
        };

        function loadReadingPassage() {
            const select = document.getElementById('passage-select');
            currentPassage = select.value;
            const passage = readingPassages[currentPassage];
            
            document.getElementById('passage-title').textContent = passage.title;
            document.getElementById('passage-text').innerHTML = passage.text;
            
            // Load questions
            const questionsContainer = document.getElementById('comprehension-questions');
            let questionsHTML = '<h4>üìù Reading Comprehension Questions</h4><div class="question-container">';
            
            passage.questions.forEach((question, index) => {
                questionsHTML += `
                    <div class="question" data-question="${index + 1}">
                        <p><strong>${index + 1}. ${question.q}</strong></p>
                        <div class="answer-options">
                            ${question.options.map((option, i) => 
                                `<label><input type="radio" name="q${index + 1}" value="${i}"> ${option}</label>`
                            ).join('')}
                        </div>
                    </div>
                `;
            });
            
            questionsHTML += '</div><button type="button" class="check-answers-btn" onclick="checkReadingAnswers()" aria-label="Check my reading comprehension answers">Check My Answers</button><div class="results-display" id="reading-results" role="status" aria-live="polite"></div>';
            questionsContainer.innerHTML = questionsHTML;
            
            // Reset timer
            readingTimer = 0;
            updateTimer();
            startReadingTimer();
        }

        function startReadingTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                readingTimer++;
                updateTimer();
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(readingTimer / 60);
            const seconds = readingTimer % 60;
            document.getElementById('reading-timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkReadingAnswers() {
            if (timerInterval) clearInterval(timerInterval);
            
            const passage = readingPassages[currentPassage];
            let score = 0;
            const results = [];
            
            passage.questions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="q${index + 1}"]:checked`);
                if (selected) {
                    if (parseInt(selected.value) === question.correct) {
                        score++;
                        results.push(`‚úÖ Question ${index + 1}: Correct!`);
                    } else {
                        results.push(`‚ùå Question ${index + 1}: Incorrect. The correct answer is "${question.options[question.correct]}"`);
                    }
                } else {
                    results.push(`‚ö†Ô∏è Question ${index + 1}: No answer selected`);
                }
            });
            
            const percentage = Math.round((score / passage.questions.length) * 100);
            let feedback = '';
            if (percentage >= 90) feedback = 'Excellent work! üåü';
            else if (percentage >= 70) feedback = 'Good job! üëç';
            else if (percentage >= 50) feedback = 'Keep practicing! üìö';
            else feedback = 'Need more practice. Try again! üí™';
            
            document.getElementById('reading-results').innerHTML = `
                <h4>Your Results</h4>
                <p><strong>Score: ${score}/${passage.questions.length} (${percentage}%)</strong></p>
                <p><strong>${feedback}</strong></p>
                <p><strong>Reading Time: ${Math.floor(readingTimer / 60)}:${(readingTimer % 60).toString().padStart(2, '0')}</strong></p>
                <div class="answer-details">${results.join('<br>')}</div>
            `;
        }

        // Creative Writing System
        const writingPrompts = {
            adventure: [
                "You discover a hidden cave behind a waterfall. What is the first thing you see inside?",
                "Your pet suddenly starts talking and asks you to go on a quest. Where do you go and why?",
                "You find a mysterious map in your attic with one place circled in red. What happens next?",
                "A friendly dragon offers to take you on a flight around the world. Describe three sights you see."
            ],
            mystery: [
                "All the clocks in your town have stopped at exactly 3:33. What clues do you find?",
                "You receive a letter addressed to someone from 100 years ago. How do you solve the mystery?",
                "Your shadow starts acting independently. What is it trying to tell you?",
                "A new student at school seems to know things they shouldn't. What is their secret?"
            ],
            friendship: [
                "Your best friend moves away, but you discover a magical way to visit them. How does it work?",
                "Two very different animals become unlikely friends. Tell their story.",
                "You have the power to bring two people together. Who do you choose and why?",
                "A shy new student sits alone at lunch. How do you help them make friends?"
            ],
            fantasy: [
                "You wake up with magical powers, but they only work when you're helping others.",
                "A talking tree in your backyard offers to grant you one wish. What do you choose?",
                "You're invited to attend a school for young wizards. Describe your first day.",
                "A constellation falls from the sky and becomes your companion. What adventures follow?"
            ]
        };

        function selectWritingPrompt(category, triggerEl) {
            const prompts = writingPrompts[category];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('prompt-text').textContent = randomPrompt;
            
            // Update button styles
            const buttons = document.querySelectorAll('.prompt-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${category}'`) || handler.includes(`\"${category}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function addDialogue() {
            const editor = document.getElementById('story-editor');
            const sampleDialogue = '\n\n"Hello there!" said [Character Name]. "How are you feeling today?"\n\n"I\'m excited about our adventure," replied [Other Character].\n\n';
            editor.value += sampleDialogue;
            updateWordCount();
        }

        function addDescription() {
            const editor = document.getElementById('story-editor');
            const sampleDescription = '\n\nThe [setting] was [adjective] and [adjective]. [Character] could [action] while [sensory detail]. It felt like [comparison or metaphor].\n\n';
            editor.value += sampleDescription;
            updateWordCount();
        }

        function showWritingTips() {
            const tips = [
                "Use descriptive words to paint a picture in the reader's mind.",
                "Start your story with action or dialogue to grab attention.",
                "Show don't tell - instead of 'he was scared', write 'his hands trembled'.",
                "Use the five senses: sight, sound, smell, taste, and touch.",
                "Give your characters unique personalities and speaking styles.",
                "Create a clear beginning, middle, and end for your story."
            ];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('writing-feedback').innerHTML = `<div class="writing-tip">üí° <strong>Writing Tip:</strong> ${randomTip}</div>`;
        }

        function updateWordCount() {
            const editor = document.getElementById('story-editor');
            const text = editor.value;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const characters = text.length;
            
            document.getElementById('word-count').textContent = words;
            document.getElementById('char-count').textContent = characters;
        }

        function saveStory() {
            const story = document.getElementById('story-editor').value;
            if (story.trim() === '') {
                alert('Please write something before saving!');
                return;
            }
            
            const blob = new Blob([story], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my-story-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('writing-feedback').innerHTML = '<div class="success-message">üìù Your story has been saved successfully!</div>';
        }

        // Epic 7 Multimedia Integration
        let multimediaSystem = null;
        let isNarrating = false;
        let isHighlighting = false;

        function initEnglishGamification() {
            if (window.GamificationSystem && !window.gamificationSystem) {
                window.gamificationSystem = new GamificationSystem({
                    subject: 'english',
                    chapter: 'english-1',
                    pointsEnabled: true,
                    badgesEnabled: true,
                    achievementsEnabled: true
                });
            }
        }

        function awardEnglishPoints(action, amount = 1) {
            if (window.gamificationSystem && typeof window.gamificationSystem.awardPoints === 'function') {
                window.gamificationSystem.awardPoints(action, amount);
            }
        }
        
        // Initialize multimedia system and word count tracking
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('story-editor');
            if (editor) {
                editor.addEventListener('input', updateWordCount);
                loadReadingPassage(); // Load initial passage
            }
            
            initEnglishGamification();

            // Initialize multimedia system
            if (window.MultimediaSystem) {
                multimediaSystem = new MultimediaSystem({
                    autoPlay: false,
                    narrationRate: 0.9,
                    highlightColor: '#ffeb3b',
                    accessibility: true
                });
                
                // Award points for using multimedia features
                awardEnglishPoints('engagement_feature');
            }
        });
        
        // Toggle narration functionality
        function toggleNarration() {
            if (!multimediaSystem) {
                alert('Multimedia system loading... Please try again in a moment.');
                return;
            }
            
            const btn = document.getElementById('narration-btn');
            const passageText = document.getElementById('passage-text').textContent;
            
            if (!isNarrating) {
                isNarrating = true;
                btn.innerHTML = '‚è∏Ô∏è Pause';
                btn.title = 'Pause narration';
                
                multimediaSystem.startNarration(passageText, {
                    rate: 0.9,
                    pitch: 1.0,
                    onEnd: () => {
                        isNarrating = false;
                        btn.innerHTML = 'üîä Listen';
                        btn.title = 'Listen to passage';
                        
                        // Award points for completing narration
                        awardEnglishPoints('narration_complete');
                    }
                });
                
                // Award points for using narration
                awardEnglishPoints('narration_start');
            } else {
                isNarrating = false;
                btn.innerHTML = 'üîä Listen';
                btn.title = 'Listen to passage';
                multimediaSystem.stopNarration();
            }
        }
        
        // Toggle highlighting functionality
        function toggleHighlighting() {
            const btn = document.getElementById('highlight-btn');
            const passageText = document.getElementById('passage-text');
            
            if (!isHighlighting) {
                isHighlighting = true;
                btn.innerHTML = 'üéØ Stop Highlight';
                btn.title = 'Stop highlighting';
                
                // Add highlighting functionality
                passageText.style.cursor = 'pointer';
                passageText.addEventListener('click', highlightText);
                
                // Add instructional message
                passageText.insertAdjacentHTML('afterbegin', 
                    '<div id="highlight-instruction" style="background: #e3f2fd; padding: 0.5rem; margin-bottom: 1rem; border-radius: 0.25rem; font-size: 0.9rem;">üëÜ Click on any sentence to highlight it!</div>'
                );
                
                // Award points for using highlighting
                awardEnglishPoints('highlighting_start');
            } else {
                isHighlighting = false;
                btn.innerHTML = '‚ú® Highlight';
                btn.title = 'Highlight as you read';
                
                passageText.style.cursor = 'default';
                passageText.removeEventListener('click', highlightText);
                
                // Remove highlights and instruction
                const instruction = document.getElementById('highlight-instruction');
                if (instruction) instruction.remove();
                
                passageText.querySelectorAll('.highlighted-text').forEach(element => {
                    element.style.backgroundColor = '';
                    element.classList.remove('highlighted-text');
                });
            }
        }
        
        // Highlight clicked text
        function highlightText(event) {
            if (event.target.tagName === 'P') {
                if (event.target.classList.contains('highlighted-text')) {
                    event.target.style.backgroundColor = '';
                    event.target.classList.remove('highlighted-text');
                } else {
                    event.target.style.backgroundColor = '#ffeb3b';
                    event.target.classList.add('highlighted-text');
                    
                    // Award points for highlighting
                    awardEnglishPoints('text_highlight');
                }
            }
        }

        // Grammar Games System
        let currentGrammarGame = null;
        let gameScore = 0;
        let questionsAnswered = 0;

        const grammarGames = {
            punctuation: {
                name: 'Punctuation Police',
                instructions: 'Help fix these sentences by choosing the correct punctuation!',
                questions: [
                    { sentence: 'What time is it', options: ['?', '!', '.', ','], correct: 0, explanation: 'Questions end with question marks.' },
                    { sentence: 'Watch out', options: ['?', '!', '.', ','], correct: 1, explanation: 'Exclamations showing strong emotion end with exclamation points.' },
                    { sentence: 'I like pizza, hamburgers and ice cream', options: [' and ice cream.', ', and ice cream.', ' and, ice cream.', ', and, ice cream.'], correct: 1, explanation: 'Use commas to separate items in a series.' },
                    { sentence: 'My favorite colors are blue green and yellow', options: [' blue green and', ' blue, green, and', ' blue green, and', ' blue, green and'], correct: 1, explanation: 'Use commas between all items in a series.' }
                ]
            },
            'parts-of-speech': {
                name: 'Parts of Speech Detective',
                instructions: 'Identify the part of speech for the highlighted word!',
                questions: [
                    { sentence: 'The *happy* dog ran quickly.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 2, explanation: 'Happy describes the dog, so it\'s an adjective.' },
                    { sentence: 'She *ran* to the store.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 1, explanation: 'Ran is an action word, so it\'s a verb.' },
                    { sentence: 'The cat sat on the *table*.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 0, explanation: 'Table is a person, place, or thing, so it\'s a noun.' },
                    { sentence: 'He spoke very *softly*.', options: ['Noun', 'Verb', 'Adjective', 'Adverb'], correct: 3, explanation: 'Softly describes how he spoke, so it\'s an adverb.' }
                ]
            },
            'sentence-structure': {
                name: 'Sentence Builder',
                instructions: 'Choose the words that make a complete sentence!',
                questions: [
                    { prompt: 'Which is a complete sentence?', options: ['Running in the park.', 'The dog barked loudly.', 'After the rain stopped.', 'Because I was tired.'], correct: 1, explanation: 'A complete sentence needs a subject and a predicate.' },
                    { prompt: 'What type of sentence is: "Close the door."', options: ['Statement', 'Question', 'Command', 'Exclamation'], correct: 2, explanation: 'This gives a command or instruction.' },
                    { prompt: 'Which sentence is a question?', options: ['I love reading books.', 'What is your favorite book.', 'What is your favorite book?', 'Read this book!'], correct: 2, explanation: 'Questions end with question marks.' },
                    { prompt: 'What makes this sentence exciting: "Wow, what a great game!"', options: ['Question mark', 'Exclamation point', 'Period', 'Comma'], correct: 1, explanation: 'Exclamation points show strong emotion or excitement.' }
                ]
            }
        };

        function startGrammarGame(gameType, triggerEl) {
            currentGrammarGame = gameType;
            gameScore = 0;
            questionsAnswered = 0;
            
            const game = grammarGames[gameType];
            document.getElementById('game-instructions').innerHTML = `
                <h4>${game.name}</h4>
                <p>${game.instructions}</p>
            `;
            
            loadGrammarQuestion(0);
            
            // Update button styles
            const buttons = document.querySelectorAll('.game-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${gameType}'`) || handler.includes(`\"${gameType}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function loadGrammarQuestion(questionIndex) {
            const game = grammarGames[currentGrammarGame];
            if (questionIndex >= game.questions.length) {
                showGrammarResults();
                return;
            }
            
            const question = game.questions[questionIndex];
            let questionHTML = '';
            
            if (question.sentence) {
                questionHTML = `
                    <div class="grammar-question">
                        <h4>Question ${questionIndex + 1} of ${game.questions.length}</h4>
                        <p class="sentence">${question.sentence.replace(/\*(.+?)\*/g, '<strong>$1</strong>')}</p>
                        <div class="grammar-options">
                            ${question.options.map((option, i) => 
                                `<button type="button" class="option-btn" onclick="selectGrammarAnswer(${questionIndex}, ${i})">${option}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                questionHTML = `
                    <div class="grammar-question">
                        <h4>Question ${questionIndex + 1} of ${game.questions.length}</h4>
                        <p class="prompt">${question.prompt}</p>
                        <div class="grammar-options">
                            ${question.options.map((option, i) => 
                                `<button type="button" class="option-btn" onclick="selectGrammarAnswer(${questionIndex}, ${i})">${option}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('game-content').innerHTML = questionHTML;
        }

        function selectGrammarAnswer(questionIndex, selectedAnswer) {
            const game = grammarGames[currentGrammarGame];
            const question = game.questions[questionIndex];
            
            questionsAnswered++;
            let feedback = '';
            
            if (selectedAnswer === question.correct) {
                gameScore++;
                feedback = `<div class="correct-answer">‚úÖ Correct! ${question.explanation}</div>`;
            } else {
                feedback = `<div class="incorrect-answer">‚ùå Incorrect. ${question.explanation}</div>`;
            }
            
            document.getElementById('game-content').innerHTML += feedback;
            
            setTimeout(() => {
                loadGrammarQuestion(questionIndex + 1);
            }, 2000);
        }

        function showGrammarResults() {
            const percentage = Math.round((gameScore / questionsAnswered) * 100);
            let message = '';
            
            if (percentage >= 90) message = 'Outstanding grammar skills! üåü';
            else if (percentage >= 70) message = 'Great job! Keep it up! üëç';
            else if (percentage >= 50) message = 'Good effort! Practice more! üìö';
            else message = 'Keep studying! You\'ll improve! üí™';
            
            document.getElementById('game-score').innerHTML = `
                <h4>Game Complete!</h4>
                <p><strong>Final Score: ${gameScore}/${questionsAnswered} (${percentage}%)</strong></p>
                <p>${message}</p>
                <button type="button" class="play-again-btn" onclick="startGrammarGame('${currentGrammarGame}')">Play Again</button>
            `;
        }

        // Vocabulary System
        const vocabularyCategories = {
            emotions: {
                name: 'Emotions & Feelings',
                words: [
                    { word: 'Elated', definition: 'Extremely happy and excited', example: 'She felt elated when she won the contest.' },
                    { word: 'Melancholy', definition: 'A gentle sadness', example: 'The rainy day made him feel melancholy.' },
                    { word: 'Serene', definition: 'Calm and peaceful', example: 'The lake looked serene in the morning.' },
                    { word: 'Bewildered', definition: 'Very confused', example: 'He was bewildered by the difficult math problem.' },
                    { word: 'Triumphant', definition: 'Feeling successful and proud', example: 'The team felt triumphant after their victory.' }
                ]
            },
            nature: {
                name: 'Nature & Environment',
                words: [
                    { word: 'Majestic', definition: 'Grand and impressive', example: 'The majestic mountains towered above the valley.' },
                    { word: 'Lush', definition: 'Rich and abundant in growth', example: 'The lush garden was full of colorful flowers.' },
                    { word: 'Pristine', definition: 'In perfect, untouched condition', example: 'The pristine lake reflected the sky perfectly.' },
                    { word: 'Vibrant', definition: 'Full of life and bright color', example: 'The vibrant sunset painted the sky orange and pink.' },
                    { word: 'Tranquil', definition: 'Quiet and peaceful', example: 'The forest was tranquil in the early morning.' }
                ]
            },
            adventure: {
                name: 'Adventure & Exploration',
                words: [
                    { word: 'Intrepid', definition: 'Brave and fearless', example: 'The intrepid explorer ventured into the unknown cave.' },
                    { word: 'Perilous', definition: 'Full of danger', example: 'The mountain climb was perilous but exciting.' },
                    { word: 'Treacherous', definition: 'Dangerous and unpredictable', example: 'The treacherous path led through the dark forest.' },
                    { word: 'Valiant', definition: 'Courageous and determined', example: 'The valiant knight rescued the villagers.' },
                    { word: 'Audacious', definition: 'Bold and daring', example: 'Her audacious plan surprised everyone.' }
                ]
            },
            descriptive: {
                name: 'Descriptive Words',
                words: [
                    { word: 'Luminous', definition: 'Giving off bright light', example: 'The luminous stars lit up the night sky.' },
                    { word: 'Colossal', definition: 'Extremely large', example: 'The colossal statue dominated the town square.' },
                    { word: 'Minuscule', definition: 'Extremely small', example: 'The minuscule ant carried a crumb twice its size.' },
                    { word: 'Gleaming', definition: 'Shining brightly', example: 'The knight\'s gleaming armor caught the sunlight.' },
                    { word: 'Ornate', definition: 'Decorated with fancy details', example: 'The ornate doorway was covered in carved flowers.' }
                ]
            }
        };

        let currentVocabCategory = null;
        let vocabQuizMode = false;

        function loadVocabCategory(category, triggerEl) {
            currentVocabCategory = category;
            const vocab = vocabularyCategories[category];
            
            let cardsHTML = `<h4>${vocab.name}</h4><div class="vocab-cards">`;
            vocab.words.forEach((wordObj, index) => {
                cardsHTML += `
                    <div class="vocab-card" onclick="flipVocabCard(${index})">
                        <div class="card-front">
                            <h3>${wordObj.word}</h3>
                            <p class="tap-hint">Tap to see definition</p>
                        </div>
                        <div class="card-back" id="card-back-${index}" style="display: none;">
                            <h3>${wordObj.word}</h3>
                            <p class="definition"><strong>Definition:</strong> ${wordObj.definition}</p>
                            <p class="example"><strong>Example:</strong> ${wordObj.example}</p>
                        </div>
                    </div>
                `;
            });
            cardsHTML += '</div>';
            
            document.getElementById('vocab-cards').innerHTML = cardsHTML;
            
            // Update button styles
            const buttons = document.querySelectorAll('.vocab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const targetButton = triggerEl || Array.from(buttons).find(btn => {
                const handler = btn.getAttribute('onclick') || '';
                return handler.includes(`'${category}'`) || handler.includes(`\"${category}\"`);
            });
            if (targetButton) targetButton.classList.add('active');
        }

        function flipVocabCard(index) {
            const front = document.querySelector(`#vocab-cards .vocab-card:nth-child(${index + 2}) .card-front`);
            const back = document.querySelector(`#vocab-cards .vocab-card:nth-child(${index + 2}) .card-back`);
            
            if (front.style.display !== 'none') {
                front.style.display = 'none';
                back.style.display = 'block';
            } else {
                front.style.display = 'block';
                back.style.display = 'none';
            }
        }

        function startVocabQuiz() {
            if (!currentVocabCategory) {
                alert('Please select a vocabulary category first!');
                return;
            }
            
            const vocab = vocabularyCategories[currentVocabCategory];
            const randomWord = vocab.words[Math.floor(Math.random() * vocab.words.length)];
            const allWords = Object.values(vocabularyCategories).flatMap(cat => cat.words);
            
            // Create wrong options
            const wrongOptions = allWords
                .filter(w => w.word !== randomWord.word)
                .sort(() => 0.5 - Math.random())
                .slice(0, 3)
                .map(w => w.definition);
            
            const options = [randomWord.definition, ...wrongOptions].sort(() => 0.5 - Math.random());
            const correctIndex = options.indexOf(randomWord.definition);
            
            let quizHTML = `
                <h4>Vocabulary Quiz</h4>
                <div class="vocab-quiz">
                    <p class="quiz-word"><strong>What does "${randomWord.word}" mean?</strong></p>
                    <div class="quiz-options">
                        ${options.map((option, i) => 
                            `<button type="button" class="quiz-option-btn" onclick="checkVocabAnswer(${i}, ${correctIndex}, '${randomWord.word}', '${randomWord.example}')">${option}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('vocab-cards').innerHTML = quizHTML;
        }

        function checkVocabAnswer(selected, correct, word, example) {
            let result = '';
            if (selected === correct) {
                result = `<div class="vocab-correct">‚úÖ Correct! "${word}" is used like this: ${example}</div>`;
            } else {
                result = `<div class="vocab-incorrect">‚ùå Incorrect. Try again!</div>`;
            }
            
            document.querySelector('.vocab-quiz').innerHTML += result;
            
            setTimeout(() => {
                if (selected === correct) {
                    loadVocabCategory(currentVocabCategory);
                }
            }, 3000);
        }

        function createWordStory() {
            if (!currentVocabCategory) {
                alert('Please select a vocabulary category first!');
                return;
            }
            
            const vocab = vocabularyCategories[currentVocabCategory];
            const wordList = vocab.words.map(w => w.word).join(', ');
            
            document.getElementById('story-editor').value = 
                `Write a short story using these vocabulary words: ${wordList}\n\n` +
                'Remember to use each word correctly based on its definition. Make your story creative and fun!\n\n' +
                'Your story:\n\n';
            
            // Scroll to writing section
            document.querySelector('.writing-editor').scrollIntoView({ behavior: 'smooth' });
            updateWordCount();
        }
    </script>
</body>
</html>
